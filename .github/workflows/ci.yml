name: CI

on: push 
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }} ${{ github.sha }}

jobs:
  ### Test
  test:
    runs-on: ubuntu-latest

    outputs:
      output_time: ${{ steps.time_start.outputs.JOB_START_TIME }}

    defaults:
      run:
        working-directory: ./angular
    steps:
      - uses: actions/checkout@v3

      - name: Get time start workflow
        run: echo "::set-output name=JOB_START_TIME::$(date +%s)"
        id: time_start
      - run: echo "${{ github.actor }}"
      - run: echo "${{ secrets.GITHUB_TOKEN }}"

      - name: Use Node.js
#        if: ${{ github.ref }} == 'develop'
        uses: actions/setup-node@v3
        with:
          node-version: 16.x
      - run: npm install
      - run: npm ci
      - run: npm run build --if-present
      - run: npm test -- --watch=false --browsers=ChromeHeadless

      ### Sending email when test is failed

      - uses: actions/checkout@v3
      - name: Send mail
        uses: ./.github/actions/send-email
        with:
          username: ${{secrets.MAIL_USERNAME}} 
          password: ${{secrets.MAIL_PASSWORD}} 
          to: ${{secrets.MAIL_ADDRESS}} 
          body: ${{env.message_body}} 
          reply_to: ${{secrets.MAIL_USERNAME}} 

